---
title: "netlit  Vignette"
author: "Devin Judge-Lord, Adeline Lo & Kyler Hudson"
subtitle: Redistricting Literature
output:
  html_document:
    highlight: zenburn
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r libraries, include=FALSE}
library(tidyverse)
library(magrittr)
library(ggraph)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE,
                      fig.width=10, 
                      fig.height=7,
                      out.width = "100%",
                      split = T,
                      fig.align = 'center', 
                      fig.path='../figs/',
                      fig.retina = 1, 
                      warning=FALSE, 
                      message=FALSE)


# Table formatting
library(kableExtra)
kablebox <- . %>% 
  slice_head(n = 100) %>%
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```


# Using the `netlit` R Package 


The `netlit`  package provides functions to generate network statistics from a literature review. Specifically, `netlit` provides a wrapper for `igraph` functions to facilitate using network analysis in literature reviews. 


Install this package with 
```
devtools::install_github("judgelord/netlit")
```

To install `netlit` from CRAN, run the following:

```
install.packages("netlit")
```

## Basic Usage

The `review()` function takes in a dataframe, `data`, that includes `from` and `to` columns (a directed graph structure). 

In the example below, we use example data from [this project on redistricting](https://github.com/judgelord/redistricting). These data are a set of related concepts (`from` and `to`) in the redistricting literature and citations for these relationships (`cites` and `cites_empirical`). See `vignette("netlit")` for more details on this example.

```{r}
library(netlit)

data("literature")

#FIXME should have loaded with data("literature")
literature <- netlit::.

literature %>% 
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

---

`netlit` offers four main functions: `make_edgelist()`, `make_nodelist()`, `augment_nodelist()`, and `review()`. 

`review()` is the primary function. The others are helper functions that perform the individual steps that `review()` does all at once. `review()` takes in a dataframe with at least two columns representing linked concepts (e.g., a cause and an effect) and returns data augmented with network statistics. Users must either specify "from" nodes and "to" nodes with the `from` and `to` arguments or include columns named `from` and `to` in the supplied `data` object.

`review()` returns a list of three objects: 

1. an augmented `edgelist` (a list of relationships with `edge_betweenness` calculated), 
2. an augmented `nodelist` (a list of concepts with `degree` and `betweenness` calculated), and 
3. a `graph` object suitable for use in other `igraph` functions or other network visualization packages. 

Users may wish to include edge attributes (e.g., information about the relationship between the two concepts) or node attributes (information about each concept). We show how to do so below. But first, consider the basic use of `review()`: 


```{r echo=TRUE}
lit <- review(literature, from = "from", to = "to")

lit

lit$edgelist  %>% 
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")

lit$nodelist  %>% 
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

Edge and node attributes can be added using the `edge_attributes` and `node_attributes` arguments. `edge_attributes` is a vector that identifies columns in the supplied data frame that the user would like to retain. `node_attributes` is a separate dataframe that contains attributes for each node in the primary data set. The example `node_attributes` data include one column `type` indicating a type for each each node/variable/concept. 

```{r}
data("node_attributes")

node_attributes %>% kablebox()

lit <- review(literature,
              edge_attributes = c("cites", "cites_empirical"),
              node_attributes = node_attributes)

lit
```

Tip: to retain all variables from `literature`, use `edge_attributes = names(literature)`.


## More Advanced Uses: larger networks, visualizating your network, network descriptives

<!-- Additional columns in the redistricting literature data include discriptions of the `edge` (the relationship between the `to` and `from` concepts), the theorized `mechanism`, and `cite_weight`---the number of studies in the literature that cite that that causal relationship.  

### A Larger Edgelist and Nodelist --> 


```{r include=FALSE}
literature$from %<>% str_replace_all("([a-z| |-]{8}) ", 
                           "\\1\n") 

literature$to %<>% str_replace_all("([a-z| |-]{8}) ", 
                           "\\1\n") 

literature$from %<>% str_replace_all(" ([a-z| |-]{9})", 
                           "\n\\1") %>% str_to_title()

literature$to %<>% str_replace_all(" ([a-z| |-]{9})", 
                           "\n\\1") %>% str_to_title()

literature$from %<>% str_replace("\nOf\n", "\nOf ")

literature$to %<>% str_replace("\nOf\n", "\nOf ")

literature$from %<>% str_replace("\nFellow ", " Fellow\n")

literature$to %<>% str_replace("\nFellow ", " Fellow\n")

literature$from %<>% str_replace("\nState\n", " State\n")

literature$to %<>% str_replace("\nState\n", " State\n")

literature$from %<>% str_replace("\nDistrict\n", " District\n")

literature$to %<>% str_replace("\nDistrict\n", " District\n")

literature$from %<>% str_replace("\nWith\n", " With\n")

literature$to %<>% str_replace("\nWith\n", " With\n")


```

We separated multiple cites to a theorized relationship with semicolons. 
Let's count the total number of citations and the number of citations to empirical work by splitting out each cite and measuring the length of that vector. 

```{r}
# count cites 
literature %<>% 
  group_by(to, from) %>% 
  mutate(cite_weight = str_split(cites, ";")[[1]]  %>% length(),
         cite_weight_empirical = str_split(cites_empirical, ";",)[[1]] %>% length(),
         cite_weight_empirical = ifelse(is.na(cites_empirical), 0, cite_weight_empirical)) %>% 
  ungroup() 

# clean up text for better visualization 
# literature %<>%  mutate(cites = cites %>% str_remove(",.*|;.*"))

# subsets 
literature %<>% mutate(communities_node = str_c(to, from) %>% str_detect("Commun"),
                       confound = case_when(
      from == "Preserve\nCommunities\nOf Interest" & to == "Rolloff" ~ T,
      from == "Voter\nInformation\nAbout Their\nDistrict" & to == "Rolloff" ~ T,
      from == "Preserve\nCommunities\nOf Interest" 
            & to == "Voter\nInformation\nAbout Their\nDistrict" ~ T,
      T ~ F),
              empirical = ifelse(!is.na(cites_empirical),
                                 "Empirical work", 
                                 "No empirical work"))
```

Now we use `review()` on this expanded edgelist, including all variables in the `literature` data with `edge_attributes = names(literature)`.

```{r}
# now with all node and edge attributes 
lit <- review(literature,
              edge_attributes = names(literature),
              node_attributes = node_attributes
              )

edges <- lit$edgelist
head(edges)

nodes <- lit$nodelist
head(nodes)
```

### The `igraph` object

```{r}
# define igraph object as g
g <- lit$graph

g
```

What does it mean?

- `D` means directed  
- `N` means named graph  
- `W` means weighted graph  
- `name (v/c)` means _name_ is a node attribute and it's a character  
- `cite_weight (e/n)` means _cite_weight_ is an edge attribute and it's numeric  

---


## With `ggraph`

We can also plot using the package `ggraph` package to plot the `igraph` object.

This package allows us to plot self-ties, but it is slightly more difficult to use ggplot features (e.g. colors and legend labels) compared to `ggnetwork`.

```{r ggraph, cache= FALSE}
# best seed 1,4, *5*
set.seed(5)

p <- ggraph(g, layout = 'fr') + 
  geom_node_point(
    aes(
      color = degree_total %>% as.factor() ),
    size = 6, 
    alpha = .7
    ) + 
  geom_edge_arc2(
    aes(
      start_cap = circle(3, 'mm'),
      end_cap = circle(6, 'mm'),
      color = cite_weight %>% as_factor(),
      linetype = empirical
      ),
    curvature = 0,
    arrow = arrow(length = unit(2, 'mm'), 
                  #angle = 45,
                  type = "open")
    ) +
  geom_edge_loop(
      aes( color = cite_weight %>% as_factor(),
      start_cap = circle(5, 'mm'),
      end_cap = circle(2, 'mm'),
      linetype = empirical
      ),
      n = 300,
      strength = .6,
    arrow = arrow(length = unit(2, 'mm'), 
                  #angle = 45, 
                  type = "open")
    ) +
  geom_node_text( aes(label = name), size = 2.3) + 
  ggplot2::theme_void() + 
  theme(legend.position="bottom") + 
  labs(edge_color = "Number of\nPublications",
       color = "Total Degree\nCentrality",
       edge_linetype = "") + 
scale_edge_color_viridis(discrete = TRUE,
                         option = "plasma", begin = 0, end = .9, direction = -1) +
  scale_color_brewer()
  #scale_color_grey(start = .95, end = .5) 

p 

```

---

#### Subgraphs

```{r ggraph-subset,fig.width=20, cache=FALSE, fig.retina=8}
p + facet_wrap("communities_node")

p + facet_wrap("confound")
```


### Betweenness

```{r ggraph-edge-betweenness}
ggraph(g, layout = 'fr') + 
  geom_node_point(size = 10, 
                  alpha = .1) + 
  theme_void() + 
  theme(legend.position="bottom"
        ) + 
  scale_color_viridis_c(begin = .5, end = 1, direction = -1, option = "cividis") + 
scale_edge_color_viridis(begin = 0.2, end = .9, direction = -1, option = "cividis")  +    
  geom_edge_arc2(aes(
    start_cap = circle(3, 'mm'),
    end_cap = circle(5, 'mm'),
    color = edge_betweenness,
    linetype = empirical),
    curvature = .1,
    arrow = arrow(length = unit(2, 'mm'), 
                  type = "closed")) + 
    geom_edge_loop(aes(color = edge_betweenness))  +
  geom_node_text(aes(label = name), 
                 size = 2.3) + 
  labs(edge_color = "Edge Betweenness",
       color = "Node Betweenness",
       edge_linetype = "") 
```

```{r ggraph-betweenness}

p <- ggraph(g, layout = 'fr') + 
  geom_node_point(
    aes(color = betweenness  ),
    size = 6, 
    alpha = .7
    ) + 
  geom_edge_arc2(
    aes(
      start_cap = circle(3, 'mm'),
      end_cap = circle(6, 'mm'),
      color = cite_weight %>% as_factor(),
      linetype = empirical
      ),
    curvature = 0,
    arrow = arrow(length = unit(2, 'mm'), 
                  #angle = 45,
                  type = "open")
    ) +
  geom_edge_loop(
      aes( color = cite_weight %>% as_factor(),
      start_cap = circle(5, 'mm'),
      end_cap = circle(2, 'mm'),
      linetype = empirical
      ),
      n = 300,
      strength = .6,
    arrow = arrow(length = unit(2, 'mm'), 
                  #angle = 45, 
                  type = "open")
    ) +
  geom_node_text( aes(label = name), size = 2.3) + 
  theme_void() + 
  theme(legend.position="bottom") + 
  labs(edge_color = "Number of\nPublications",
       color = "Betweeneness",
       edge_linetype = "") + 
scale_edge_color_viridis(discrete = TRUE,
                         option = "plasma", begin = 0, end = .9, direction = -1) +
  scale_color_gradient2()

p 


ggraph(g, layout = 'fr') + 
  geom_node_point(aes(color = betweenness),
                  size = 10, 
                  alpha = 1) + 
  theme_void() + 
  theme(legend.position="bottom"        ) + 
 scale_color_viridis_c(begin = .5, end = 1, direction = -1, option = "cividis") + 
scale_edge_color_viridis(begin = 0.2, end = .9, direction = -1, option = "cividis")  +    
  #scale_color_gradient2(low = "light blue") + 
  geom_edge_arc2(aes(
    start_cap = circle(3, 'mm'),
    end_cap = circle(5, 'mm'),
    color = edge_betweenness,
    linetype = empirical),
    curvature = .1,
    arrow = arrow(length = unit(2, 'mm'), 
                  type = "closed")) + 
    geom_edge_loop(aes(color = edge_betweenness
                     )) +
  labs(edge_color = "Edge Betweenness",
       color = "Node Betweenness",
       edge_linetype = "") + 
  geom_node_text(aes(label = name), 
                 size = 2.3) 
```

### Coreness

```{r ggraph-coreness, eval=FALSE}
#TODO
p <- ggraph(g, layout = 'fr') + 
  geom_node_point(
    aes(color = coreness  ),
    size = 6, 
    alpha = .7
    ) + 
  geom_edge_arc2(
    aes(
      start_cap = circle(3, 'mm'),
      end_cap = circle(6, 'mm'),
      color = cite_weight %>% as_factor(),
      linetype = empirical
      ),
    curvature = 0,
    arrow = arrow(length = unit(2, 'mm'), 
                  #angle = 45,
                  type = "open")
    ) +
  geom_edge_loop(
      aes( color = cite_weight %>% as_factor(),
      start_cap = circle(5, 'mm'),
      end_cap = circle(2, 'mm'),
      linetype = empirical
      ),
      n = 300,
      strength = .6,
    arrow = arrow(length = unit(2, 'mm'), 
                  #angle = 45, 
                  type = "open")
    ) +
  geom_node_text( aes(label = name), size = 2.3) + 
  theme_void() + 
  theme(legend.position="bottom") + 
  labs(edge_color = "Number of\nPublications",
       color = "Coreness",
       edge_linetype = "") + 
scale_edge_color_viridis(discrete = TRUE,
                         option = "plasma", begin = 0, end = .9, direction = -1) +
  scale_color_gradient2()

p 
```

### Degree

```{r ggraph-degree-total, fig.retina=8}
ggraph(g, layout = 'fr') + 
  geom_node_point(aes(color = degree_total),
                  size = 10, 
                  alpha = 1) + 
  theme_void() + 
  theme(legend.position="bottom"        ) + 
  scale_color_gradient2() + 
scale_edge_color_viridis(begin = 0.2, end = .9, direction = -1, option = "cividis")  +    
  geom_edge_arc2(aes(
    start_cap = circle(3, 'mm'),
    end_cap = circle(5, 'mm'),
    color = edge_betweenness,
    linetype = empirical),
    curvature = .1,
    arrow = arrow(length = unit(2, 'mm'), 
                  type = "closed")) + 
    geom_edge_loop(aes(color = edge_betweenness
                     )) +
  labs(edge_color = "Edge Betweenness",
       color = "Total Degree",
       edge_linetype = "") + 
  geom_node_text(aes(label = name), 
                 size = 2.3) 
```



---























